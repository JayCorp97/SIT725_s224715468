<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Register | Recipe Management System</title>

  <link rel="stylesheet" href="css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />
</head>

<body>

<div class="login-wrapper">
  <div class="login-card">

    <h2>Create Account âœ¨</h2>
    <p class="subtitle">Register to start managing recipes</p>

    <div class="error-message" id="error"></div>

    <form id="registerForm">

      <div class="input-group">
        <span class="icon">ðŸ‘¤</span>
        <input type="text" id="f_name" placeholder="First Name" required />
      </div>

      <div class="input-group">
        <span class="icon">ðŸ‘¤</span>
        <input type="text" id="l_name" placeholder="Last Name" required />
      </div>

      <div class="input-group">
        <span class="icon">ðŸ“§</span>
        <input type="email" id="email" placeholder="Email Address" required />
      </div>

      <div class="input-group">
        <span class="icon">ðŸ”’</span>
        <input type="password" id="password" placeholder="Password" required />
      </div>
      <div class="password-validation-container">
        <div class="password-requirements" id="passwordRequirements" style="display: none;">
          <small class="requirements-title">Password must contain:</small>
          <ul id="requirementList">
            <li id="req-length">At least 8 characters</li>
            <li id="req-upper">One uppercase letter</li>
            <li id="req-lower">One lowercase letter</li>
            <li id="req-number">One number</li>
            <li id="req-special">One special character</li>
          </ul>
        </div>
        <div class="password-strength" id="passwordStrength" style="display: none;">
          <div class="strength-bar">
            <div class="strength-fill" id="strengthFill"></div>
          </div>
          <span class="strength-text" id="strengthText"></span>
        </div>
      </div>

      <div class="input-group">
        <span class="icon">ðŸ”’</span>
        <input type="password" id="confirm_password" placeholder="Confirm Password" required />
        <div class="password-match" id="passwordMatch" style="display: none;"></div>
      </div>

      <button type="submit" class="login-btn">Register</button>

    </form>

    <p class="register-text">
      Already have an account? <a href="login.html">Login</a>
    </p>

  </div>
</div>

<style>
  .password-validation-container {
    margin-top: -1rem;
    margin-bottom: 1.5rem;
  }
  
  .password-requirements {
    padding: 12px 16px;
    background: #FFFFFF;
    border: 1px solid #E0E0E0;
    border-radius: 8px;
    font-size: 13px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    margin-bottom: 8px;
  }
  
  .requirements-title {
    display: block;
    font-weight: 600;
    color: #333333;
    margin-bottom: 8px;
    font-size: 12px;
  }
  
  .password-requirements ul {
    margin: 0;
    padding-left: 20px;
    list-style: none;
  }
  
  .password-requirements li {
    margin: 4px 0;
    color: #E53935;
    transition: color 0.3s;
    font-size: 12px;
    line-height: 1.5;
    position: relative;
  }
  
  .password-requirements li::before {
    content: "âœ—";
    position: absolute;
    left: -18px;
    color: #E53935;
  }
  
  .password-requirements li.valid {
    color: #4CAF50;
  }
  
  .password-requirements li.valid::before {
    content: "âœ“";
    color: #4CAF50;
  }
  
  .password-strength {
    margin-top: 8px;
  }
  
  .strength-bar {
    width: 100%;
    height: 5px;
    background: #E0E0E0;
    border-radius: 3px;
    overflow: hidden;
  }
  
  .strength-fill {
    height: 100%;
    transition: width 0.3s, background-color 0.3s;
    width: 0%;
  }
  
  .strength-fill.weak { 
    width: 33%; 
    background-color: #E53935; 
  }
  
  .strength-fill.medium { 
    width: 66%; 
    background-color: #FF9800; 
  }
  
  .strength-fill.strong { 
    width: 100%; 
    background-color: #4CAF50; 
  }
  
  .strength-text {
    display: block;
    margin-top: 6px;
    font-size: 12px;
    color: #666666;
    font-weight: 500;
  }
  
  .password-match {
    margin-top: 5px;
    font-size: 12px;
    padding: 5px;
    border-radius: 4px;
    font-weight: 500;
  }
  
  .password-match.match {
    color: #4CAF50;
  }
  
  .password-match.no-match {
    color: #E53935;
  }
</style>

<script>
  const form = document.getElementById("registerForm");
  const error = document.getElementById("error");
  const passwordInput = document.getElementById("password");
  const confirmPasswordInput = document.getElementById("confirm_password");
  const passwordRequirements = document.getElementById("passwordRequirements");
  const requirementList = document.getElementById("requirementList");
  const passwordStrength = document.getElementById("passwordStrength");
  const strengthFill = document.getElementById("strengthFill");
  const strengthText = document.getElementById("strengthText");
  const passwordMatch = document.getElementById("passwordMatch");

  // Password validation function
  function validatePassword(password) {
    const checks = {
      length: password.length >= 8,
      upper: /[A-Z]/.test(password),
      lower: /[a-z]/.test(password),
      number: /[0-9]/.test(password),
      special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
    };
    return checks;
  }

  // Calculate password strength
  function calculateStrength(checks) {
    const validCount = Object.values(checks).filter(v => v).length;
    if (validCount <= 2) return { level: 'weak', text: 'Weak' };
    if (validCount <= 4) return { level: 'medium', text: 'Medium' };
    return { level: 'strong', text: 'Strong' };
  }

  // Update password requirements display
  function updatePasswordRequirements(password) {
    if (password.length === 0) {
      passwordRequirements.style.display = 'none';
      passwordStrength.style.display = 'none';
      return;
    }

    passwordRequirements.style.display = 'block';
    passwordStrength.style.display = 'block';

    const checks = validatePassword(password);
    const strength = calculateStrength(checks);

    // Update requirement list
    document.getElementById('req-length').classList.toggle('valid', checks.length);
    document.getElementById('req-upper').classList.toggle('valid', checks.upper);
    document.getElementById('req-lower').classList.toggle('valid', checks.lower);
    document.getElementById('req-number').classList.toggle('valid', checks.number);
    document.getElementById('req-special').classList.toggle('valid', checks.special);

    // Update strength bar
    strengthFill.className = 'strength-fill ' + strength.level;
    strengthText.textContent = `Password Strength: ${strength.text}`;
  }

  // Check password match
  function checkPasswordMatch() {
    const password = passwordInput.value;
    const confirm = confirmPasswordInput.value;

    if (confirm.length === 0) {
      passwordMatch.style.display = 'none';
      return;
    }

    passwordMatch.style.display = 'block';
    if (password === confirm) {
      passwordMatch.textContent = 'âœ“ Passwords match';
      passwordMatch.className = 'password-match match';
    } else {
      passwordMatch.textContent = 'âœ— Passwords do not match';
      passwordMatch.className = 'password-match no-match';
    }
  }

  // Real-time password validation
  passwordInput.addEventListener('input', (e) => {
    updatePasswordRequirements(e.target.value);
    checkPasswordMatch();
  });

  confirmPasswordInput.addEventListener('input', checkPasswordMatch);

  // Form submission
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const f_name = document.getElementById("f_name").value.trim();
    const l_name = document.getElementById("l_name").value.trim();
    const email = document.getElementById("email").value.trim();
    const password = passwordInput.value;
    const confirm_password = confirmPasswordInput.value;

    error.textContent = "";

    // Client-side password validation
    const passwordChecks = validatePassword(password);
    const allValid = Object.values(passwordChecks).every(v => v);
    
    if (!allValid) {
      error.textContent = "Password does not meet all requirements";
      return;
    }

    // Confirm password check
    if (password !== confirm_password) {
      error.textContent = "Passwords do not match";
      return;
    }

    try {
      const res = await fetch("/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ f_name, l_name, email, password, confirm_password })
      });

      const data = await res.json();

      if (!res.ok) {
        // Handle password validation errors from backend
        if (data.error) {
          // Backend returns { error: { code, message, details } }
          if (data.error.details && Array.isArray(data.error.details)) {
            error.textContent = data.error.details.join(". ");
          } else {
            error.textContent = data.error.message || "Registration failed";
          }
        } else if (data.errors && Array.isArray(data.errors)) {
          error.textContent = data.errors.join(". ");
        } else {
          error.textContent = data.message || "Registration failed";
        }
        return;
      }

      // Auto-login: Save token and redirect to dashboard
      if (data.token) {
        localStorage.setItem('token', data.token);
        window.location.href = 'dashboard.html';
      } else {
        // Fallback if token not received
        alert("Registration successful! Please login.");
        window.location.href = "login.html";
      }
    } catch (err) {
      error.textContent = "Network error, please try again.";
      console.error(err);
    }
  });
</script>

</body>
</html>
